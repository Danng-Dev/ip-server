name: üê≥ Docker Build & Push (Simple)

on:
  push:
    branches: ['main', 'master']
    tags: ['v*.*.*']
  pull_request:
    branches: ['main', 'master']
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: üè∑Ô∏è Set image tags
        id: tags
        run: |
          # Lowercase the image name (required for GHCR)
          IMAGE_NAME=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          echo "image=${{ env.REGISTRY }}/$IMAGE_NAME" >> $GITHUB_OUTPUT
          
          # Build tag list
          TAGS=""
          
          # Always add SHA tag
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAGS="${{ env.REGISTRY }}/$IMAGE_NAME:$SHORT_SHA"
          
          # Add latest for main/master branch
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/master" ]]; then
            TAGS="$TAGS,${{ env.REGISTRY }}/$IMAGE_NAME:latest"
          fi
          
          # Add version tags for releases
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            TAGS="$TAGS,${{ env.REGISTRY }}/$IMAGE_NAME:$VERSION"
            TAGS="$TAGS,${{ env.REGISTRY }}/$IMAGE_NAME:latest"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Image: ${{ env.REGISTRY }}/$IMAGE_NAME"
          echo "Tags: $TAGS"

      - name: üê≥ Build Docker image
        run: |
          IMAGE=${{ steps.tags.outputs.image }}
          TAGS=${{ steps.tags.outputs.tags }}
          
          # Build with first tag
          FIRST_TAG=$(echo "$TAGS" | cut -d',' -f1)
          echo "Building: $FIRST_TAG"
          
          docker build \
            --tag "$FIRST_TAG" \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            --build-arg VERSION=${{ github.ref_name }} \
            .
          
          # Tag with additional tags
          IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
          for tag in "${TAG_ARRAY[@]}"; do
            if [ "$tag" != "$FIRST_TAG" ]; then
              echo "Tagging: $tag"
              docker tag "$FIRST_TAG" "$tag"
            fi
          done

      - name: üîê Login to GHCR
        if: github.event_name != 'pull_request'
        run: |
          echo "${{ secrets.TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: üì§ Push Docker image
        if: github.event_name != 'pull_request'
        run: |
          TAGS=${{ steps.tags.outputs.tags }}
          IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
          
          for tag in "${TAG_ARRAY[@]}"; do
            echo "Pushing: $tag"
            docker push "$tag"
          done

      - name: ‚úÖ Verify push
        if: github.event_name != 'pull_request'
        run: |
          echo "‚úÖ Successfully pushed images:"
          TAGS=${{ steps.tags.outputs.tags }}
          IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
          for tag in "${TAG_ARRAY[@]}"; do
            echo "  - $tag"
          done
